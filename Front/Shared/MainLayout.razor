@inherits LayoutComponentBase
@inject NavigationManager NavigationManager

<MudThemeProvider IsDarkMode="false" />
<MudDialogProvider CloseOnEscapeKey="true" CloseButton="true"/>
<MudSnackbarProvider/>

<AuthorizeView>
    <Authorized>
        <MudLayout>
            <MudAppBar Elevation="1" Dense="true">
                <MudButton
                    Href="/" Target="_self"
                    StartIcon="@Icons.Material.Filled.Games"
                    IconSize="Size.Large"
                    Variant="Variant.Text"
                    Style="color: white;"
                >
                    Syki
                </MudButton>
                <MudSpacer />
                <MudText>@_userName</MudText>
                <MudSpacer />
                <MudTooltip Text="Account">
                    <MudMenu Icon="@Icons.Material.Filled.AccountCircle" Color="Color.Inherit" Dense="true" AnchorOrigin="Origin.BottomCenter" TransformOrigin="@Origin.BottomCenter">
                        <MudMenuItem>Profile</MudMenuItem>
                        <MudMenuItem>My account</MudMenuItem>
                        <MudMenuItem Disabled="true">Logout</MudMenuItem>
                    </MudMenu>
                </MudTooltip>

                <MudTooltip Text="Settings">
                    <MudMenu Icon="@Icons.Material.Filled.Settings" Color="Color.Inherit" Dense="true" AnchorOrigin="Origin.BottomCenter" TransformOrigin="@Origin.BottomCenter">
                        <MudMenuItem>Campus</MudMenuItem>
                        <MudMenuItem>Provas</MudMenuItem>
                        <MudMenuItem>Boletos</MudMenuItem>
                    </MudMenu>
                </MudTooltip>

                <MudTooltip Text="Logout">
                    <MudIconButton Icon="@Icons.Material.Filled.Logout" Color="Color.Inherit" OnClick="Logout" />
                </MudTooltip>
            </MudAppBar>
            <MudDrawer Open="true" ClipMode="DrawerClipMode.Always" Elevation="2">
                <NavMenu />
            </MudDrawer>
            <MudMainContent>
                <CascadingValue Value="@AppState">
                    @Body
                </CascadingValue>
            </MudMainContent>
        </MudLayout>
    </Authorized>
    <NotAuthorized>
        @if (NavigationManager.Uri.ToLower().Contains("login") || NavigationManager.Uri.ToLower().Contains("register"))
        {
            <MudLayout>
                <MudMainContent>
                    <CascadingValue Value="@AppState">
                        @Body
                    </CascadingValue>
                </MudMainContent>
            </MudLayout>
        }
        else
        {
            <SykiRedirect />
        }
    </NotAuthorized>
</AuthorizeView>

@using Syki.Front.Auth
@using System.Security.Claims

@code {
    public AppState AppState = new AppState();

    [CascadingParameter]
    public Task<AuthenticationState> AuthState { get; set; }

    [Inject]
    public AuthService AuthService { get; set; }

    private string _userName = "";

    protected override async Task OnInitializedAsync()
    {
        await SetUserName();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        base.OnAfterRender(firstRender);

        await SetUserName();
    }

    private async Task SetUserName()
    {
        var state = await AuthState;

        var claim = state.User.FindFirst("name");
        if (claim != null)
        {
            _userName = claim.Value;
        }
    }

    private async Task Logout()
    {
        await AuthService.Logout();
        NavigationManager.NavigateTo("/login");
    }
}
